From 7303c576a7144e5821dd20c6dadfae24e4f42b07 Mon Sep 17 00:00:00 2001
From: "duncan.macleod" <duncan.macleod@ligo.org>
Date: Thu, 1 Dec 2022 10:16:47 +0000
Subject: [PATCH] FIRtools.py: work around int_max_str_digits

see https://git.ligo.org/Calibration/gstlal-calibration/-/issues/13
---
 python/FIRtools.py | 19 ++++++++++++++++---
 1 file changed, 16 insertions(+), 3 deletions(-)

diff --git a/python/FIRtools.py b/python/FIRtools.py
index 346f1276d..7c696e1c8 100644
--- a/python/FIRtools.py
+++ b/python/FIRtools.py
@@ -990,9 +990,22 @@ def test_many4(start = 2, end = 100):
 factorials_inv = np.zeros(1755, dtype = np.float128)
 factorials_inv[0] = 1.0
 current = 1
-for n in range(1, 1755):
-	current *= n
-	factorials_inv[n] = 1.0 / np.float128(str(current))
+try:
+	maxdigits = sys.get_int_max_str_digits()
+except AttributeError:  # python < 3.11 (or <3.10.7, <3.9.14, <3.8.14)
+	pass
+else:
+	# (temporarily) increase the limit on str->int conversions
+	sys.set_int_max_str_digits(5000)
+try:
+	for n in range(1, 1755):
+		current *= n
+		factorials_inv[n] = 1.0 / np.float128(str(current))
+finally:  # make sure we replace the original limit
+	try:
+		sys.set_int_max_str_digits(maxdigits)
+	except AttributeError:
+		pass
 
 
 #
-- 
2.37.3

